README file for code 

A/ MATLAB 

file : traitement_imag_calc_test_affichage_162.m

The code is a Matlab tool to visualize 2-photon calcium images, and manually select cells that meet the activation criterion. 

A.1 / System requirements

-	Pc computer with windows 10 or windows 11. Code not tested on linux nor iOS. 
-	A licenced Matlab. Code was developed on R2019a and successfully tested on R2024b, with the following toolboxes : Image Processing Toolbox, Signal Processing Toolbox
-	Bioformats toolbox (https://docs.openmicroscopy.org/bio-formats/5.8.2/users/matlab/index.html)

A.2 / Installation guide

No installation is required. Just copy the file traitement_imag_calc_test_affichage_162.m in the matlab directory, open it and press F5. 
Alternatively, one can type “traitement_imag_calc_test_affichage_162” in the Matlab command window.

A.3/ Demo

-	After launch, user will be prompted to open an image file. Accepted format are czi, tif or tiff file. 
-	Then a second windows will ask the user whether images need extra processing to compensate drift, rotation and/or shear, and ask for size of the median and gaussian filters. 
-	The selected processes are then computed, with an execution time between 10s and 120s depending on the computed speed, and the main widow opens.
-	Within the main window, the user can
  - Add, delete, move cells
  - Change the Z plane and Time plane
  - Change images min and max
  - Change the colormap, and the image processing for time image and SD image
  - Visualize the time course of the current pixel, with real time calculation of BaseLine and activation criterion
  - Change time period of BaseLine and Stimulation
  - Change activation level (number od standard deviation over baseline, and offset)
  - Add anatomical zones
  - Export and import data
  - Export transients (pop up for additional parameters)
  - Export images (pop up for additional parameters)

Output of the code can be either : 
-	an excel fil listing all cells, sorted by stack, with raw fluorescence, dF/F, associated zones, and metadata
-	copy of images
-	print of all transients as a multi stack tiff file

A.4/ test file

Unzip "Data test and results.7z" file containing an image and its corresponding results to be used with the code

B / PYTHON

Files : model_transformation_control_cuff.py and nalyse_solutions.ipynb 

The code to generate the solutions of potential transformations from control to cuff dorsal horn network is model_transformation_control_cuff.py
The code to analyse the solutions is Analyse_solutions.ipynb 

B.1 / System requirements

-	Pc computer with windows 10 or windows 11. Code not tested on linux nor iOS. 
-	Jupyter Notebook

B.2 / Installation guide

No installation is required (python packages). Just copy the files model_transformation_control_cuff.py, Analyse_solutions.ipynb and percentages_experimental_cell_types.xlsx in the same folder.

B.3/ Description of model_transformation_control_cuff.py

This code allows the read the file 'percentages_experimental_cell_types.xlsx' to get the % of the different cell types obtained experimentally.
To run it, please chose the lamina (see just below) and run the full code.
It will generate a folder named "solutions laminaX" (X depends on the lamina chosen).
In this folder, the solutions of the algorithm will stored (one csv file per solution found).
In a given csv file, the first column represent the 1000 cells in control condition in the form [B,S,P,H,C]. Each letter can be a -1 (modality not present), 0 (modality present but inhibited) or 1 (modality expressed). The second column are the same cells but in cuff condition (after disinhibition of some modalities).
The control condition is generated from the experimental data, respecting the % of the various modalities in control and disinhibited condition. The cuff condition is generated by iterative partial disinhibition (some 0 turned to 1 in some cells) of the control condition until we obtain the % of modalities in experimental cuff condition.
Both control and cuff condition are generated with a 30% error margin of the experimental %. It means that if % of cell type X is 5% the max accepted error is 5*30/100=1.5%. Therefore, a % btw 3.5% and 6.5% will be considered OK.
In this code lamina1 represents lamina I-IIo of dorsal horn, lamina2 is lamina IIi, lamina3 is lamina III-V
Importantly, in this code cuff and CCI are synonymous and for the Dynamic modality, we use the letter 'B' for brush.
Note the code stops when it found 1000 different solutions for a given lamina. It takes several hours to run.

B.4/ Description of Analyse_solutions.ipynb

This code read the file 'percentages_experimental_cell_types.xlsx' to get the % of the different cell types obtained experimentally.
It takes the csv files produced by the model (folder 'solutions lamX') and select the 5 solutions closest to the experimental values and presenting the smallest amount of modifications to go from control to cuff network.
Then, it analyses these solutions to get the % of cell types in control, dishinibited and cuff conditions in the differents solutions found by the model.
It give also the % of transformations from one cell type into an other cell type when going from control to cuff condition.
It generates the files:
1) percentages_BSPHC_model_lamX.xlsx used for Fig. S9A
2) percentages_conc_cell_types_model_lamX.xlsx used for Fig. 7B, Fig. 7C, S9B, S9C, Table 2, Table 3, Table 4
3) Percentages_transfo_control_to_CCI_lamX.xlsx Used for Fig. 7D
4) Transformations_Control_CCI_lamX.xlsx used for Fig.S10
5) Percentage_Control_cell_types_among_CCI_responders_lamX.xlsx used for Fig.S10

To generate these files, please chose the lamina (see just below) and run the full code

Importantly, in this code cuff and CCI are synonymous and for the Dynamic modality, we use the letter 'B' for brush.


